<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<title>Greek Vocab DB</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

<script type="text/javascript" src="jquery.min.js"></script>
  <script type="text/javascript" src="wordtree.js?v10"></script>
<script>
/*
<?php 
if ( isset($_GET["wordid"]) ) {
    echo "var landingWordId = " . $_GET["wordid"] . ";\n";
}

?>
*/
//var landingWordId = -1;

function setTheme() {
    var mode = localStorage.getItem("mode");
    if ((window.matchMedia( "(prefers-color-scheme: dark)" ).matches || mode == "dark") && mode != "light") {
        document.querySelector("HTML").classList.add("dark");
    }
    else {
        document.querySelector("HTML").classList.remove("dark");
    }
}
setTheme();

const TYPE_WORD = 0;
const TYPE_PUNCTUATION = 1;
const TYPE_SPEAKER = 2;
const TYPE_SECTION = 4;
const TYPE_VERSE_LINE = 5;
const TYPE_PARA_WITH_INDENT = 6;
const TYPE_WORK_TITLE = 7;
const TYPE_SECTION_TITLE = 8;
const TYPE_INLINE_SPEAKER = 9;
const TYPE_PARA_NO_INDENT = 10;

      //https://github.com/le717/microajax
      function microAjax(options) {
      "use strict";

      // Default to GET
      if (!options.method) {
        options.method = "GET";
      }

      // Default empty functions for the callbacks
      function noop() {}
      if (!options.success) {
        options.success = noop;
      }
      if (!options.warning) {
        options.warning = noop;
      }
      if (!options.error) {
        options.error = noop;
      }

      var request = new XMLHttpRequest();
      request.open(options.method, options.url, true);
      request.send(options.data);

      request.onload = function() {
        // Success!
        if (request.readyState === 4 && request.status === 200) {
          options.success(request.responseText);

          // We reached our target destination, but it returned an error
        } else {
          options.warning(request.responseText);
        }
      };

      // There was a connection error of some sort
      request.onerror = options.error;
    }

function wasmSupported() {
    try {
        if (typeof WebAssembly === "object"
            && typeof WebAssembly.instantiate === "function") {
            const module = new WebAssembly.Module(Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00));
            if (module instanceof WebAssembly.Module) {
                console.log("WebAssembly is supported");
                return new WebAssembly.Instance(module) instanceof WebAssembly.Instance;
            }
        }
    } catch (e) {
        return false;
    }
    console.log("WebAssembly is not supported");
    return false;
}

    function loadWebAssembly(filename, imports) {
      // Fetch the file and compile it
        /*
        const importObject = {
          imports: {
            imported_func: function(arg) {
              console.log(arg);
            }
          }
        };
        */
        if ( typeof(fetch) == "function" ) {
            return fetch(filename)
                .then(function(response){ return response.arrayBuffer()})
                .then(function(buffer){ return WebAssembly.compile(buffer)})
                .then(function(module){ return WebAssembly.instantiate(module)});
        }
        else {
            return false;
        }
    }

function stripDiacriticsLocal(origChars) {
    
    var len = origChars.length;
    //add letter and any combining diacritics to the buffer as code points
    for (var i = 0; i < len; i++) {
        wasmBuffer[i] = origChars.codePointAt(i);
    }

    len = stripDiacritics2(wasmBuffer.byteOffset, len, 1);
    //transform the returned code points back to a string
    var newLetter = "";
    for (var i = 0; i < len; i++) {
        newLetter += String.fromCodePoint(wasmBuffer[i]);
    }
    return newLetter;
}

var wasmBuffer;
var wasmBuffer1;
var wasmBuffer2;
var accentSyllableWASM;
var stripDiacritics2;
var compareWASM;

try {
loadWebAssembly('hoplitekb.wasm')
  .then(function(instance) {
    var exports = instance.exports;
    accentSyllableWASM = exports.accentSyllable2;
    stripDiacritics2 = exports.stripDiacritics;
    compareWASM = exports.compare;
    var memory = exports.memory;

    wasmBuffer = new Uint16Array(memory.buffer, 0, 1024);
    wasmBuffer1 = new Uint16Array(memory.buffer, 1024, 1024);
    wasmBuffer2 = new Uint16Array(memory.buffer, 2048, 1024);
    /*
    // now we are ready, set up the button so the user can run the code
    var button = document.getElementById('b');
    button.value = 'Call a method in the WebAssembly module';
    button.addEventListener('click', compareLocal);
    */
  },function(){console.log("error")}
);
} catch(e) { console.log(e.message)};

var la = ["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
var gr = ["α","β","ψ","δ","ε","φ","γ","η","ι","ξ","κ","λ","μ","ν","ο","π","","ρ","σ","τ","θ","ω","ς","χ","υ","ζ","Α","Β","Ψ","Δ","Ε","Φ","Γ","Η","Ι","Ξ","Κ","Λ","Μ","Ν","Ο","Π","","Ρ","Σ","Τ","Θ","Ω","Σ","Χ","Υ","Ζ"];
var forceLowercase = false;
function transliterate(char)
{
    var theChar = (forceLowercase) ? char.toLowerCase() : char;
    var idx = la.indexOf(theChar);
    if (idx > -1) {
        return gr[idx];
    }
    else {
        return char;
    }
}

function accentSyllable(origChars, key) {
    var len = origChars.length;
    //add letter and any combining diacritics to the buffer as code points
    for (var i = 0; i < len; i++) {
        wasmBuffer[i] = origChars.codePointAt(i);
    }

    len = accentSyllableWASM(wasmBuffer.byteOffset, len, key, 1, parseInt(unicodeMode) );

    //transform the returned code points back to a string
    var newLetter = "";
    for (var i = 0; i < len; i++) {
        newLetter += String.fromCodePoint(wasmBuffer[i]);
    }

    //let win1251decoder = new TextDecoder('utf-16le');
    return [len, newLetter];
}

var unicodeMode = 1; //pua
function handleKey(evt) {
    var val = this.value;
    evt = evt || window.event;

    if (typeof(accentSyllableWASM) != "function") {
        return true;
    }

    var charCode = typeof(evt.which) == "number" ? evt.which : evt.keyCode;

    if (charCode && charCode > 64 && charCode < 123) //letter
    {
        var start = this.selectionStart;
        var end = this.selectionEnd;
        var key = String.fromCharCode(charCode);

        var mappedChar = transliterate(key);
        var charsToReplace = 0;
        this.value = val.slice(0, start - charsToReplace) + mappedChar + val.slice(end);
        // Move the caret
        this.selectionStart = this.selectionEnd = start + 1 - charsToReplace;
        return false;
    }
    else if (charCode && charCode > /*47 blocking underdot here*/47 && charCode < 58) { //number: 0-9 are 48-57
        var key = String.fromCharCode(charCode);
        var hckey = 0;
        switch( parseInt(key) ) {
            case 1:
                hckey = 5; //rough
                break;
            case 2:
                hckey = 6; //smooth
                break;
            case 3:
                hckey = 1; //acute
                break;
            case 4:
                hckey = 3; //grave
                break;
            case 5:
                hckey = 2; //circumflex
                break;
            case 6:
                hckey = 4; //macron
                break;
            case 7:
                hckey = 10; //breve
                break;
            case 8:
                hckey = 7; //iota subscript
                break;
            case 9:
                hckey = 9; //diaeresis
                break;
            case 0:
                hckey = 11; //underdot
                break;
        }
        var start, end;
        if (typeof(this.selectionStart) == "number" && typeof(this.selectionEnd) == "number") {
            // Non-IE browsers and IE 9+
            start = this.selectionStart;
            end = this.selectionEnd;

            var combining = [0x0300, 0x0301, 0x0304, 0x0306, 0x0308, 0x0313, 0x0314, 0x0323, 0x0342, 0x0345];
            var off = 1;
            for (var i = start; i > -1; i--)
            {
                if (combining.indexOf(val.codePointAt(i - 1)) > -1) {
                    off++;
                }
                else {
                    break;
                }
            }
            //0 pre
            //1 pua
            //2 comp
            //unicodeMode = 1;//$("input:radio[name='unicodeMode']:checked").val();

            var ret = accentSyllable(val.slice(start - off, start), hckey.toString());
            var newLetter = ret[1];
            var charsToReplace = start - (start - off);
 
            if (ret[0] > 0 && newLetter != "")
            {
                //update the input/textarea
                this.value = val.slice(0, start - charsToReplace) + newLetter + val.slice(end);
                // Move the caret
                this.selectionStart = this.selectionEnd = (start - charsToReplace) + ret[0];
            }

        } 
        return false;
    }
    return true;
}

    var lemmaListWordTree = null;
    var textListWordTree = null;
    var glossUsesWordTree = null;
    function onload()
    {
        /*
        var blah = new Array();
        for (var i = 0; i < 2000; i++)
        {
            blah.push(["blah",i]);
        }
        var t = "";
        blah.forEach(function (i,v) {
            var a = document.getElementById("wordscontents"); 
            
            var b = document.createElement("div"); 
            b.id = "word" + i[1];
            b.className += "listword";
            b.setAttribute("tabindex","0");
            b.innerHTML = i[0] + i[1];
            a.appendChild(b);
            t += "<span id='text" + i[1] + "' class='textword'>" + i[0] + "<\/span>"+ "<span class='superscript'>" + i[1] + "<\/span> ";
        });
        var text = document.getElementById("textcontents"); 
        text.innerHTML = t;
        $(".textword").click(function() {scrollToTextID(this.id)});
        $(".listword").click(function() {scrollToWordID(this.id)});
        //$("#words").css("border","2px solid green");
        */

//

        var thisText = getCookie("selectedText");     
        if (thisText === null || parseInt(thisText) < 1/* || parseInt(thisText) > 116*/)
        {
            thisText = 1;
        }
        //fix me get landingWord from wordid GET variable if present, else it should be left undefined
        if ( typeof(landingWordId) != "undefined" ) {
            getTextByWordId(landingWordId);
        }
        else
        {
            getwords(parseInt(thisText));//ion = 2
        }

        var w = new wordtree("test1", 480, $(document).height() - 38);
        w.columnOffsets = [0,0,0,0];
        w.params.lexicon = "hqvocab";
        w.url = "queryglosses";
        w.params.mode = "context";
        w.show(document.getElementById("leftlist"));
        lemmaListWordTree = w;
        w.hideFunction = hideLemmaList;

	    var title = "<div style='width:100%;position:relative;font-family:helvetica;padding-left:10px;'>Glosses<button id='glosslistSelectButton' onclick='selectGlossClicked()'>Assign</button><button id='glosslistEditButton' onclick='editGlossListClicked()'>Edit</button><button id='showGlossUsesButton' onclick='showGlossUsesClicked()'>Occurrences</button><button id='glosslistclosebutton' onclick='hideLemmaList()'>X</button></div>";
        w.title.innerHTML = title;
        
        //w.refresh(); //fix me: this was causing the select option box to not show selected option? maybe don't need it anyway
        w.onEnterActivate = addLemmaIDEnter;//addWordToList;
        //w.onEnterActivate = removeDuplicate;
        //w.onClickActivate = act;
        //w.onSelectionChanged = act;

        $("#test1Entry").css("font-size", "14pt").addClass("gkinput");
        $(".gkinput").keypress(handleKey);



        var w2 = new wordtree("text", 480, $(document).height() - 38);
        w2.columnOffsets = [0,0,0,0];
        w2.params.lexicon = "hqvocab";
        w2.url = "querytexts";
        w2.params.mode = "normal";
        w2.refreshOnESC = false;

        w2.show(document.getElementById("textlist"));
        textListWordTree = w2;
        w2.hideFunction = hideTextList;

	    var title = "<div style='width:100%;position:relative;font-family:helvetica;padding-left:10px;'>Texts<!--<div style='height: 26px;width: 43px;border-radius:4px;border: 1px solid black;position: absolute;top: -5px;right: 28px;text-align: center;cursor:pointer;' onclick='newLemmaFormShow()'><div style='padding:6px;'>N</div></div>--><button id='selectTextButton' onclick='selectTextClicked()'>Select</button><button id='uploadbutton' onclick='uploaddialog()'>Upload</button><button id='testlistclosebutton' onclick='hideTextList()'>X</button></div>";
        w2.title.innerHTML = title;

        //w2.refresh(); //fix me: this was causing the select option box to not show selected option? maybe don't need it anyway
        w2.onEnterActivate = queryText;
        //w2.onClickActivate = act;
        //w2.onSelectionChanged = act;
        //$("#textContainer").css({"top":"41px"});
        $("#textEntry").css({"font-size":"14pt","display":"block"});

        var w3 = new wordtree("glossuses", 480, $(document).height() - 38);
        w3.columnOffsets = [0,0,0,0];
        w3.params.lexicon = "hqvocab";
        w3.url = "glossuses";
        w3.params.mode = "normal";
        w3.refreshOnESC = false;

        w3.show(document.getElementById("glossuseslist"));
        glossUsesWordTree = w3;
        w3.hideFunction = hideGlossUsesList;

	    var title = "<div style='width:100%;position:relative;font-family:helvetica;padding-left:10px;'>Gloss Occurrences<button id='gotoGlossOccurrenceButton' onclick=''>Go to Occurrence</button><button id='glossusesclosebutton' onclick='hideGlossUsesList()'>X</button></div>";
        w3.title.innerHTML = title;

        //w2.refresh(); //fix me: this was causing the select option box to not show selected option? maybe don't need it anyway
        //w3.onEnterActivate = queryText;
        //w2.onClickActivate = act;
        //w2.onSelectionChanged = act;
        //$("#textContainer").css({"top":"41px"});
        $("#glossusesEntry").css({"font-size":"14pt","display":"block"});
        onResize();
    }
    
    function showGlossUsesClicked() {
        let row = document.querySelector("#test1 .selectedRowClass");
        if (row) {
            showGlossUsesList(getColumnValues(row)[1]);
        }
    }
    function editGlossListClicked() {
        let row = document.querySelector("#test1 .selectedRowClass");
        if (row) {
            editLemmaFormToggle2(getColumnValues(row)[1]);
        }
    }
    function selectGlossClicked() {
        let row = document.querySelector("#test1 .selectedRowClass");
        if (row) {
            addLemmaIDEnter("hqvocab", getColumnValues(row));
        }
    }

    function selectTextClicked() {
        let row = document.querySelector("#text .selectedRowClass");
        if (row) {
            queryText("hqvocab", getColumnValues(row) );
        }
    }

    function queryText(lex, cols) {
        //alert(cols);
        if (Array.isArray(cols) && cols.length > 1 && Number.isInteger(parseInt(cols[1]))) {
            selectedWordInList = null;
            getwords(cols[1]);
            //setCookie("selectedText", cols[1], 60); set this when received in procResponse
            hideTextList();
        }
    }

    function selectLemmaFormToggle()
    {
        /*if (selectedWordInList === null)
        {
            alert("First select a word.");
            return;
        }*/
        if ( $("#leftlist").is(":visible") ) {
            hideLemmaList();
        }
        else {
            hideTextList();
            hideGlossUsesList();
            showLemmaList();
        }
    }

    function selectTextFormToggle()
    {
        /*if (selectedWordInList === null)
        {
            alert("First select a word.");
            return;
        }*/
        if ( $("#textlist").is(":visible") ) {
            hideTextList();
        }
        else {
            hideLemmaList();
            hideGlossUsesList();
            showTextList();
        }
    }

    function showNoClick()
    {
        $("#noclick").css("display", "block");
    }
    function hideNoClick()
    {
        $("#noclick").css("display", "none");
    }

    function annotateGloss() {
        if (selectedWordInList === null)
        {
            alert("You must select a word to edit.");
            return;
        }
        var a = $("#word" + selectedWordInList);
        if (a.length < 1)
        {
            alert("Try re-selecting your word and try again.");
            return;
        }        

        if ( $("#annotateformcontainer").is(":visible") ) {
            annotateFormClose();
        }
        else {
            getAnnotateData(selectedWordInList);
            annotateFormShow();
        }  
    }
    function annotateFormShow()
    {
        annotateFormClear();
        $("#annotateformcontainer").show();
        $("#annotateform").show();
        $("#AnnotateInput").focus();
        showNoClick();
    }    
    function annotateFormClose()
    {
        $("#annotateformcontainer").hide();
        $("#annotateform").hide();
        hideNoClick();
    }
    function annotateFormClear()
    {
        $("#AnnotateInput").val("");
    }

    function editLemmaFormToggle()
    {
        if (selectedWordInList === null)
        {
            alert("You must select a word to edit.");
            return;
        }
        var a = $("#word" + selectedWordInList);
        if (a.length < 1)
        {
            alert("Try re-selecting your word and try again.");
            return;
        }
        var lemmaid = a.attr("lemmaid");
        if (typeof(lemmaid) == "undefined" || lemmaid === null || lemmaid == ""|| lemmaid == 0)
        {
            alert("A gloss must be set on a word before you can edit it.  Use Select Gloss.");
            return;
        }

        if ( $("#editformcontainer").is(":visible") ) {
            newLemmaFormClose();
        }
        else {
            $("#editFormTitle").html("<b>Edit</b>");
            $("#EditInputHQID").html(""); //clear before loading
            getEditLemmaData(lemmaid);

            newLemmaFormShow();
        }        
    }

    function editLemmaFormToggle2(lemmaid) {
        $("#editFormTitle").html("<b>Edit</b>");
        $("#EditInputHQID").html(""); //clear before loading
        getEditLemmaData(lemmaid);

        newLemmaFormShow();
    }

    function uploaddialog()
    {
        if ( $("#uploadform").is(":visible") ) {
            $("#uploadform").hide();
        }
        else {
            $("#uploadform").show();
        }
    }
    function newLemmaFormToggle()
    {
        if ( $("#editformcontainer").is(":visible") ) {
            newLemmaFormClose();
        }
        else {
            $("#editFormTitle").html("<b>New</b>");
            $("#EditInputHQID").html(""); //clear before loading
            newLemmaFormShow();
        }
    }
    function newLemmaFormShow()
    {
    	newLemmaFormClear();
    	$("#arrowedrow").hide();
    	$("#editformcontainer").show();
    	$("#editform").show();
        $("#EditInputLemma").focus();
        showNoClick();
    }
    function newLemmaFormClose()
    {
    	$("#editformcontainer").hide();
    	$("#editform").hide();
        hideNoClick();
    }
	function newLemmaFormClear()
	{
		$("#EditInputGloss").val("");
		$("#EditInputPOS").val("");
        $("#EditInputNote").val("");
        //$("#EditInputNotef").val("");
		$("#EditInputLemma").val("");
		$("#EditInputArrowed").attr("checked",false);
	}
    
    function showLemmaList()
    {
        //$("#test1Entry")[0].value = "";
        lemmaListWordTree.url = "queryglosses";
        lemmaListWordTree.refresh();
        //var a = "";
        //var a = '{"wtprefix":"test1","container":"test1Container","requestTime":"99999","selectId":"0","page":"0","lastPage":"0","lastPageUp":"1","scroll":"top","query":"a","cols":"2","arrOptions":[{"i":1,"r":["Α","abc"]},{"i":5,"r":["ἃ","abc"]},{"i":2,"r":["ἀ1","abc"]},{"i":20395,"r":["α1","abc"]},{"i":3,"r":["ἀ2","abc"]},{"i":102761,"r":["α2","abc"]},{"i":4,"r":["ἆ3","abc"]},{"i":6,"r":["ἄα","abc"]},{"i":8,"r":["ἀάβακτοι","abc"]},{"i":9,"r":["ἀαγής","abc"]}]}'; 
        $("#leftlist").css("display", "");
        $("#test1Entry").focus();
        //showNoClick();
    }
    function hideLemmaList()
    {
        $("#test1Entry")[0].value = "";
        $("#leftlist").css("display", "none");
        lemmaListWordTree.clearWordTree();
        hideNoClick();
    }

    function showTextList()
    {
        //$("#test1Entry")[0].value = "";
        textListWordTree.url = "querytexts";
        textListWordTree.refresh();
        //var a = "";
        //var a = '{"wtprefix":"test1","container":"test1Container","requestTime":"99999","selectId":"0","page":"0","lastPage":"0","lastPageUp":"1","scroll":"top","query":"a","cols":"2","arrOptions":[{"i":1,"r":["Α","abc"]},{"i":5,"r":["ἃ","abc"]},{"i":2,"r":["ἀ1","abc"]},{"i":20395,"r":["α1","abc"]},{"i":3,"r":["ἀ2","abc"]},{"i":102761,"r":["α2","abc"]},{"i":4,"r":["ἆ3","abc"]},{"i":6,"r":["ἄα","abc"]},{"i":8,"r":["ἀάβακτοι","abc"]},{"i":9,"r":["ἀαγής","abc"]}]}'; 
        $("#textlist").css("display", "");
        $("#textEntry").focus();
        //showNoClick();
    }
    function hideTextList()
    {
        $("#textEntry")[0].value = "";
        $("#textlist").css("display", "none");
        textListWordTree.clearWordTree();
        hideNoClick();
    }

    function showGlossUsesList(gloss_id)
    {
        hideTextList();
        hideLemmaList();
        //$("#test1Entry")[0].value = "";
        glossUsesWordTree.url = "glossuses";
        glossUsesWordTree.params.tag_id = parseInt(gloss_id);
        glossUsesWordTree.refresh();

        //var a = "";
        //var a = '{"wtprefix":"test1","container":"test1Container","requestTime":"99999","selectId":"0","page":"0","lastPage":"0","lastPageUp":"1","scroll":"top","query":"a","cols":"2","arrOptions":[{"i":1,"r":["Α","abc"]},{"i":5,"r":["ἃ","abc"]},{"i":2,"r":["ἀ1","abc"]},{"i":20395,"r":["α1","abc"]},{"i":3,"r":["ἀ2","abc"]},{"i":102761,"r":["α2","abc"]},{"i":4,"r":["ἆ3","abc"]},{"i":6,"r":["ἄα","abc"]},{"i":8,"r":["ἀάβακτοι","abc"]},{"i":9,"r":["ἀαγής","abc"]}]}'; 
        $("#glossuseslist").css("display", "");
        $("#glossusesEntry").focus();

        hideLemmaList();

        //showNoClick();
    }
    function hideGlossUsesList()
    {
        $("#glossusesEntry")[0].value = "";
        $("#glossuseslist").css("display", "none");
        glossUsesWordTree.clearWordTree();
        hideNoClick();
    }

    function toggleLemmaList(wordid)
    {
        /*
        $("#listheadword" + wordid).attr('contentEditable',true);
        $("#listpos" + wordid).attr('contentEditable',true);
        $("#listdef" + wordid).attr('contentEditable',true);
        */
        if ( $("#listheadword" + wordid).is(":visible") )
        {
            $("#listheadword" + wordid).css("display","none");
            $("#listpos" + wordid).css("display","none");
            $("#listdef" + wordid).css("display","none");
            var a = $("#editform").detach();
            a.css("display","");
            $("#word" + wordid).prepend(a);

            $("#EditInputLemma").val( $("#listheadword" + wordid).html() );
            $("#EditInputPOS").val( $("#listpos" + wordid).html() );
            $("#EditInputGloss").val( $("#listdef" + wordid).html() );

/*
            var l = $("<input></input>");
            l.addClass("wordInput");
            l.attr("id", "wordInput" + wordid);
            l.attr("type", "text");
            $("#word" + wordid).prepend(l);

            var a = $("<input></input>");
            a.addClass("wordInput");
            a.attr("id", "wordInput" + wordid);
            a.attr("type", "text");
            $("#word" + wordid).prepend(a);

            var a1 = $("<input></input>");
            a1.addClass("wordInput");
            a1.attr("id", "wordInput" + wordid);
            a1.attr("type", "text");
            $("#word" + wordid).prepend(a1);

            var a2 = $("<input></input>");
            a2.addClass("wordInput");
            a2.attr("id", "wordInput" + wordid);
            a2.attr("type", "text");
            $("#word" + wordid).prepend(a2);
            */
        }
        else
        {
            var a = $("#editform").detach();
            a.css("display","none");
            $("#editformcontainer").append(a);

            $("#listheadword" + wordid).css("display","");
            $("#listpos" + wordid).css("display","");
            $("#listdef" + wordid).css("display","");
        }
        /*
        if ($("#leftlist").is(":visible") == true)
        {
            hideLemmaList();
        }
        else
        {
            showLemmaList();
        }
        */
    }

    var selectedWordInList = null;
    //click on wordlist
    function scrollToWordID(id)
    {   
        if ( $("#" + id).hasClass("selectedWord") ) {
            return;
        }
        selectedWordInList = null;

        var match = id.match(/word(\d+)/);
        if (match && match.length > 1)
        {
            var wordsid = "text" + match[1];
            selectedWordInList = match[1];
            console.log("Selected word from list: " + selectedWordInList);

            //alert(selectedWordInList);
            $(".selectedWord").removeClass("selectedWord");
            $("#" + id).addClass("selectedWord");
            //$("#" + id).html("<input type='text' id='abc' name='abc'/><input type='text' id='abc' name='abc'/><input type='text' id='abc' name='abc'/><br><input type='text' id='abc' name='abc'/><input type='text' id='abc' name='abc'/><input type='text' id='abc' name='abc'/>");
            $("#" + wordsid).addClass("selectedWord");
            
            
            var a = document.getElementById(wordsid);
            if (a) {
                a.scrollIntoView({
                    behavior: 'auto',
                    block: 'center',
                    inline: 'center'
                });
            }

            $("#editbutton").remove();
            /* remove edit button for now
            if ( $("#" + id).hasClass("hqListWord") )
            {
	            $("#" + id).append("<div id='editbutton'><button onclick='toggleLemmaList(" + match[1] + ")'>edit</button></div>");
        	}
        	*/
        }
    }
    
    function scrollToTextID(id)
    {
        var match = id.match(/text(\d+)/);
        if (match && match.length > 1)
        {
            var wordsid = "word" + match[1];
            selectedWordInList = match[1];
            console.log("Selected word from text: " + selectedWordInList);

            $(".selectedWord").removeClass("selectedWord");
            $("#" + id).addClass("selectedWord");
            $("#" + wordsid).addClass("selectedWord");
            
            var a = document.getElementById(wordsid);
            if (a) {
                a.scrollIntoView({
                    behavior: 'auto',
                    block: 'center',
                    inline: 'center'
                });
            }
        }
    }

    function getTextByWordId(wordid)
    {
        console.log("getting words from text by wordid: " + wordid);
        var url = "query?wordid=" + wordid + "&text=0";;
        $.ajax({
            url: url,
            type: "GET",
            data: {},
            dataType: "text",//JSON automatically deserializes json
            success: function (data, textStatus, jqXHR){ 
                procResponse(data, textStatus); 
            },
            error: function(response) {
                console.log("error getting words by wordid... trying again...");
                getwords(url); //redo request on error

            }
        });
    }
    
    function getwords(text)
    {
        console.log("getting words from text: " + text);
        var url = "query?text=" + text + "&wordid=0";
    	$.ajax({
    		url: url,
    		type: "GET",
    		data: {},
    		dataType: "text",//JSON automatically deserializes json
    		success: function (data, textStatus, jqXHR){ 
    			procResponse(data, textStatus); 
                
    		},
    		error: function(response) {
                console.log("error getting words... trying again...");
    			//getwords(url); //redo request on error
                return;
    		}
	    });
    }

    function insertSpaceAfter(w) {
        var punc = ["—"];
        if (punc.indexOf(w) > -1) {
            return false;
        }
        else {
            return true;
        }
    }

    function insertSpaceBefore(w) {
        //if (w == ">" || w == ";" || w == ";" || w == "·" || w == "." || w == "," || w == "·" || w == ";") {

        var punc = [">", ";"/*037E*/, "·"/*0387*/, "᾽", ":", ";", "·", ".", ",", "·", ";", "’", "—", "'"];
        if (punc.indexOf(w) > -1) {
            return false;
        }
        else {
            return true;
        }
    }

    function procResponse(str, status)
    {
        //console.log("Proc Response: " + str);
        //alert(str);
        
        var returnObj;
        try {
            if (typeof JSON != "undefined") {
                returnObj = JSON.parse(str);
            }
            else {
                return;
            }
        }
        catch(e) { alert("Error: " + e.message + "\n" + str); return};
        
        if (!returnObj)
            return;

        if (returnObj.error) {
            if (returnObj.error == "Not logged in") {
                location = "/login"
            }
            console.log(returnObj.error);
            return;
        }

        $("#showButton").css("display", "");
        $("#hideButton").css("display", "none");
        if (returnObj.thisText && Number.isInteger(parseInt(returnObj.thisText))) {
            setCookie("selectedText", returnObj.thisText, 60);
        }
            
        //alert(returnObj.blah[2].word);
//types
//0 word
//1 punct
//2 speaker
//4 section
//5 new line for verse #
//6 new para with indent
//7 work title
//8 section title centered
//9 inline speaker, so 2, but inline
//10 new para without indent
/*
const TYPE_WORD = 0;
const TYPE_PUNCTUATION = 1;
const TYPE_SPEAKER = 2;
const TYPE_SECTION = 4;
const TYPE_VERSE_LINE = 5;
const TYPE_PARA_WITH_INDENT = 6;
const TYPE_WORK_TITLE = 7;
const TYPE_SECTION_TITLE = 8;
const TYPE_INLINE_SPEAKER = 9;
const TYPE_PARA_NO_INDENT = 10;
*/
        
        var t = "";
        var a = document.getElementById("wordscontents"); 
        a.innerHTML = ""; //clear old content
        var firstOfSection = true;

        var lastWord = false;

        if (returnObj.words && Array.isArray(returnObj.words)) {
            returnObj.words.forEach(function (i,v) {

                i.w = i.w.trim(); //because there are some spaces in the punctuation of Xenophon and elsewhere.  Maybe remove them in the db?

                //build gloss
                if (i.t < TYPE_PUNCTUATION )//&& !i.l)
                {
                    var b = document.createElement("div"); 
                    b.id = "word" + i.i;
                    if (i.hqid !== null)
                    {
                        b.setAttribute("lemmaid", i.hqid);
                    }
                    //b.setAttribute("seq", i.s);
                    
                    b.className += "listword";
                    //b.setAttribute("tabindex","0");
                    
                    if (i.l) //parseInt(i.u) < 21)
                    {
                        b.className += " hqListWord";
                    }
                    if (!i.l) //lemma is null
                    {
                        b.innerHTML = "<div class='clickablelistword'><span class='listheadword'>" + i.w + "</span><span style='display:none;' id='lemmaAdd" + i.i + "'>" + i.l1 + "</span></div>";
                    }
                    else
                    {
                        var arrowedClass = "";

                        if (i.arrowed_text_seq === i.word_text_seq && i.s2 === i.s) {
                            b.className += " arrowedHere";
                        }
                        else if ((i.arrowed_text_seq !== null && i.arrowed_text_seq < i.word_text_seq) || (i.arrowed_text_seq !== null && i.arrowed_text_seq === i.word_text_seq && i.s2 !== null && parseInt(i.s2) < parseInt(i.s))) {
                            b.className += " alreadyArrowed"; //hide it
                        }
                        /*
                        if (i.s2 === i.s) { //if i.a == i.i then arrowed; if i.a < i.i it will be hidden
                            b.className += " arrowedHere";
                        }
                        else if (i.s2 !== null && parseInt(i.s2) < parseInt(i.s)) //hideable
                        {
                            b.className += " alreadyArrowed";
                        }
                        */
                        if (i.if && parseInt(i.if) == 1) {
                            b.className += " flagged";
                        }
                        //setListRow(textwordid, lemmaid, lemma, pos, def, arrowed, seq);
                        b.innerHTML = getListWordString(i.i, i.l, i.pos, i.def, i.rc, i.c, i.hqid);//"<div id='arrow" + i.i + "' class='listarrow'></div><div class='clickablelistword'><span class='listheadword' id='listheadword" + i.i + "'>" + i.l + "</span>.&nbsp;&nbsp;<span class='listposwrapper' style='font-style:italic;'>(<span class='listpos' id='listpos" + i.i + "'>" + i.pos + "</span>) </span><span class='listdef' id='listdef" + i.i + "'>" + i.def + "</span> <a class='listfrequency' href=''>[" + i.rc + " of " + i.c + "]</a></div>";
                    }
                    b.setAttribute("textseq", i.word_text_seq);
                    if (i.arrowed_text_seq) {
                        b.setAttribute("arrowedtextseq", i.arrowed_text_seq);
                    }
                    a.appendChild(b);
                }

                //build text
                if (i.t == TYPE_SPEAKER || i.t == TYPE_SECTION)
                {
                    if (firstOfSection) {
                        firstOfSection = false;
                    }
                    else {
                        t += "<br><br>"; //not for first section
                    }

                    i.w = "<b>" + i.w + "</b><br>";
                    t += i.w.replace("[section]", "");
                }
                else if (i.t == TYPE_WORK_TITLE || i.t == TYPE_SECTION_TITLE) {
                    t += "<b>" + i.w + "</b><br/><br/>";
                }
                else if (i.t == TYPE_VERSE_LINE)
                {
                    t += "<br>" + i.w.replace("[line]", "") + "&nbsp;&nbsp;&nbsp;";
                }
                else
                {
                    t += ((insertSpaceBefore(i.w) && lastWord !== false && insertSpaceAfter(lastWord)) ? " " : "") + "<span id='text" + i.i + "' class='textword'>" + i.w + "<\/span>" /*+ "<span class='superscript'>" + i.i + "<\/span> "*/;
                    lastWord = i.w;
                }
            });
        }
        var text = document.getElementById("textcontents");
        text.innerHTML = t;
        if (returnObj.selectedid && parseInt(returnObj.selectedid) > 0) {

            scrollToWordID("word" + returnObj.selectedid);
            scrollToTextID("text" + returnObj.selectedid);
            
        }
        else {
            $("#text").scrollTop(0);
            $("#words").scrollTop(0);
        }
        $(".textword").click(function() {scrollToTextID(this.id)});
        $(".clickablelistword").click(function() {scrollToWordID(this.parentNode.id)});
        $(".listarrow").click(toggleArrow);
        
        //$("#words").css("border","2px solid green");
    }
    /*
    function addGloss(id)
    {
    	selectedWordInList = id;
        //alert(selectedWordInList);
    	showLemmaList();
    }
    */

    function hide1()
    {
        $(".alreadyArrowed").css("display","none");
        $("#hideButton").css("display","none");
        $("#showButton").css("display","");
    }
    function show1()
    {
        $(".alreadyArrowed").css("display","block");
        $("#showButton").css("display","none");
        $("#hideButton").css("display","");
    }

    function showToast(msg) {
  // Get the snackbar DIV
  console.log(msg); //also save to console
  var x = document.getElementById("snackbar");
  if (msg)
  {
    x.innerHTML = msg;
    }
  x.className = "show";
  // After 3 seconds, remove the show class from DIV
  setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
} 

/**** ajax calls to db ******/
function removeDuplicate(lex, id) 
{     
    var vlemmaid = id[1];
    
    //showToast("clicked: " + vlemmaid + ", " + vlemmastr);
    //hideLemmaList();

    //console.log("xxx");//selectedWordInList + ", " + vlemmaid + ", " + vlemmastr);
    realRemoveDuplicate(selectedWordInList, vlemmaid);
}

function addLemmaIDEnter(lex, id) 
{     
    //alert("blah: " + lex + ", " + id);
    if (selectedWordInList === null)
    {
        alert("First select a word.");
        return;
    }
    var vlemmaid = id[1];
    var vlemmastr = "";
    var a = $("#lemmaAdd" + selectedWordInList);
    if (a.length > 0) {
        vlemmastr = a[0].innerHTML;
    }
    
    //showToast("clicked: " + vlemmaid + ", " + vlemmastr);
    hideLemmaList();

    console.log("addLemmaIDEnter: " + selectedWordInList + ", " + vlemmaid + ", " + vlemmastr);
    realAddLemmaIDEnter(selectedWordInList, vlemmaid, vlemmastr);
}

function annotateFormSubmit()
{
    alert("Doesn't work yet!");
    /*
    annotateFormClose();
    return;

    var id = $("#AnnotateWordID").html();
    var newNote = $("#AnnotateInput").val();

    //remove returns, tabs, and trim
    newNote = newNote.replace(/---/g, "—");
    newNote = newNote.replace(/[\t\n\r\b]/g, "").replace(/  +/g, ' ').trim();

    if (id !== null && id != "")
    {
        console.log("edit annotation: " + id);
        realEditLemmaFormSubmit(editHQID, newLemma, newPOS, newGloss, newNote);
    }
    annotateFormClose();
    */
}

function newLemmaFormSubmit()
{
    var editHQID = $("#EditInputHQID").html();
    var newLemma = $("#EditInputLemma").val();
    var newPOS = $("#EditInputPOS").val();
    var newGloss = $("#EditInputGloss").val();
    var newNote = $("#EditInputNote").val();

    if (!newLemma || newLemma.length < 1)
    {
        alert("Lemma field cannot be empty.");
        return;
    }
    if (!newPOS || newPOS.length < 1)
    {
        alert("POS field cannot be empty.");
        return;
    }
    if (!newGloss || newGloss.length < 1)
    {
        alert("Gloss field cannot be empty.");
        return;
    }

    //remove returns, tabs, and trim
    newLemma = newLemma.replace(/---/g, "—");
    newLemma = newLemma.replace(/[\t\n\r\b]/g, "").replace(/  +/g, ' ').trim();
    newPOS = newPOS.replace(/[\t\n\r\b]/g, "").replace(/  +/g, ' ').trim();
    newGloss = newGloss.replace(/---/g, "—");
    newGloss = newGloss.replace(/[\t\n\r\b]/g, "").replace(/  +/g, ' ').trim();
    newNote = newNote.replace(/---/g, "—");
    newNote = newNote.replace(/[\t\n\r\b]/g, "").replace(/  +/g, ' ').trim();

    if (editHQID !== null && editHQID != "")
    {
        console.log("edit: " + editHQID);
        realEditLemmaFormSubmit(editHQID, newLemma, newPOS, newGloss, newNote);
    }
    else
    {
        console.log("insert");
        realNewLemmaFormSubmit(newLemma, newPOS, newGloss, newNote);
    }
    newLemmaFormClose();
}

var vToggleArrowPending = false;
function toggleArrow() 
{
    if (vToggleArrowPending) {
        return;
    }
    var arrowID = this.id;
    var textwordid = arrowID.substring(5); //without "arrow" prefix
    var lemmaid = this.parentNode.getAttribute("lemmaid");
    var toggleOff = ( $("#" + arrowID).parents(".arrowedHere").length > 0 );

    realToggleArrow(textwordid, lemmaid, toggleOff);
}

/***** real ajax functions ******/

function getAnnotateData(vWordid)
{
    console.log("get annotation: " + vWordid);
   $.ajax({
        url: "updatedb",
        type: "POST",
        data: {qtype:"getWordAnnotation",wordid:vWordid },
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            //procResponse(data, textStatus); 
            //showToast("success: " + data);
            console.log("get annotation: " + data);
            var returnObj;
            try {
                if (typeof JSON != "undefined") {
                    returnObj = JSON.parse(data);
                }
                else {
                    returnObj = eval("(" + data + ")");
                }
            }
            catch(e) { alert("Error: " + e.message + "\n" + data); return};
            
            if (!returnObj)
                return;

            var w = returnObj.words;

            for (var i = 0; i < w.length; i++)
            {
                $("#AnnotateWordID").html(w[i].wid);
                $("#AnnotateInput").val(w[i].an);    
            }
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error in realAddLemmaIDEnter: " + vlemmaid + ", " + vlemmastr);
            console.log("error in realAddLemmaIDEnter: " + vlemmaid + ", " + vlemmastr);
        }
    });
}
function getEditLemmaData(vLemmaid)
{
    console.log("get lemmaid: " + vLemmaid);
   $.ajax({
        url: "getgloss",
        type: "POST",
        data: { qtype:"getLemma", lemmaid:parseInt(vLemmaid) },
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            //procResponse(data, textStatus); 
            //showToast("success: " + data);
            console.log("get lemma: " + data);
            var returnObj;
            try {
                if (typeof JSON != "undefined") {
                    returnObj = JSON.parse(data);
                }
                else {
                    returnObj = eval("(" + data + ")");
                }
            }
            catch(e) { alert("Error: " + e.message + "\n" + data); return};
            
            if (!returnObj)
                return;

            var w = returnObj.words;

            for (var i = 0; i < w.length; i++)
            {
                //var wid = w[i].i;
                $("#EditInputHQID").html(w[i].hqid);
                $("#EditInputLemma").val(w[i].l);
                $("#EditInputPOS").val(w[i].pos);
                $("#EditInputGloss").val(w[i].g);
                $("#EditInputNote").val(w[i].n);
                //var lemmaid = w[i].hqid
                //var lemma = w[i].l;
                //var pos = w[i].pos;
                //var gloss = w[i].g;     
            }
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error in realAddLemmaIDEnter: " + vlemmaid + ", " + vlemmastr);
            console.log("error in realAddLemmaIDEnter: " + vlemmaid + ", " + vlemmastr);
        }
    });
}

function realRemoveDuplicate(vTextWordID, vlemmaid)
{
    return;
    /*
   $.ajax({
        url: "updatedb",
        type: "POST",
        data: {qtype:"removeDuplicate",textwordid:vTextWordID, lemmaid:vlemmaid},
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){  
            showToast("success: " + data);
            console.log("remove duplicate: " + data);
        },
        error: function(response) {
            showToast("error in realRemoveDuplicate: " + vlemmaid);
        }
    });
    */
}

function realAddLemmaIDEnter(vTextWordID, vlemmaid, vlemmastr)
{
   $.ajax({
        url: "updatedb",
        type: "POST",
        data: {qtype:"updateLemmaID",textwordid:vTextWordID, lemmaid:vlemmaid, lemmastr:vlemmastr},
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            //procResponse(data, textStatus); 
            
            console.log("update lemma: " + data);
            var returnObj;
            try {
                if (typeof JSON != "undefined") {
                    returnObj = JSON.parse(data);
                }
                else {
                    returnObj = eval("(" + data + ")");
                }
            }
            catch(e) { alert("Error: " + e.message + "\n" + data); return};
            
            showToast("gloss updated: " + returnObj.success);

            if (!returnObj || returnObj.affectedrows < 1)
                return;

            var w = returnObj.words;

            for (var i = 0; i < w.length; i++)
            {
                var wid = w[i].i;
                var lemmaid = w[i].hqid;
                var lemma = w[i].l;
                var pos = w[i].pos;
                var gloss = w[i].g;
                //var seq = w[i].seq;

                if ( updateListWordByWordID(wid, lemma, pos, gloss, lemmaid, w[i].rc, w[i].fr, w[i].ls, w[i].ws, w[i].fl) ) {
                    $("#word" + wid + " .clickablelistword").click(function() {scrollToWordID(this.parentNode.id)});
                    $("#arrow" + wid).click(toggleArrow);
                }
                //alert("(" + w[i].rc + " of " + w[i].fr + ") " + w[i].ws + ", " + w[i].ls);
            }
            
            /*
            else {
                console.log("error");
                return;
            }
            */
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error in realAddLemmaIDEnter: " + vlemmaid + ", " + vlemmastr);
        }
    });
}

function updateAllListWordsWithLemmaID(lemma, pos, gloss, lemmaid)
{
    $(".listword[lemmaid='" + lemmaid + "']").each(function(idx,el){
        var $e = $(el);
        $e.find(".listheadword").html(lemma);
        $e.find(".listpos").html(pos);
        $e.find(".listdef").html(gloss);
    });
}

function getListWordString(wid, lemma, pos, gloss, count, total, gloss_id) {
    return "<div id='arrow" + wid + "' class='listarrow'></div><div class='clickablelistword'><span class='listheadword' id='listheadword" + wid + "'>" + lemma + "</span>.&nbsp;&nbsp;<span class='listposwrapper' style='font-style:italic;'>(<span class='listpos' id='listpos" + wid + "'>" + pos + "</span>) </span><span class='listdef' id='listdef" + wid + "'>" + gloss + "</span> <a class='listfrequency' href='javascript:showGlossUsesList(" + gloss_id + ")'>(" + count + " of " + total + ")</a></div>";
}

function updateListWordByWordID(wid, lemma, pos, gloss, lemmaid, count, total, lemmaSeq, wordSeq, flagged, arrowed_text_seq, word_text_seq)
{
    var $a = $("#word" + wid);
    if ($a.length > 0) {

        $a.id = "word" + wid;
        $a.removeClass();
        $a.addClass("listword hqListWord");
        $a.attr("lemmaid", lemmaid);
        //$a.attr("seq", seq);

        /*if (lemmaSeq === wordSeq) { //if i.a == i.i then arrowed; if i.a < i.i it will be hidden
            $a.addClass("arrowedHere");
        }
        else if (lemmaSeq !== null && parseInt(lemmaSeq) < parseInt(wordSeq)) //hideable
        {
            $a.addClass("alreadyArrowed");
        }*/

        if (arrowed_text_seq === word_text_seq && lemmaSeq === wordSeq) {
            $a.addClass("arrowedHere");
        }
        else if ((arrowed_text_seq !== null && arrowed_text_seq < word_text_seq) || (arrowed_text_seq !== null && arrowed_text_seq === word_text_seq && lemmaSeq !== null && parseInt(lemmaSeq) < parseInt(wordSeq))) {
            $a.addClass("alreadyArrowed"); //hide it
        }

        if (flagged == "1") {
            $a.addClass("flagged");
        }
        else {
            $a.removeClass("flagged");
        }
        
        var row = getListWordString(wid, lemma, pos, gloss, count, total, lemmaid);
        $a.html(row);
        return true;
    }
    return false;
}

function realEditLemmaFormSubmit(editHQID, newLemma, newPOS, newGloss, newNote)
{
    if (typeof(accentSyllableWASM) != "function") {
        console.log("Error: does not support editing: no wasm.");
        return;
    }
    var newLemmaStripped = stripDiacriticsLocal(newLemma);
    console.log("stripped: " + newLemmaStripped);

    var editOrInsert = "";
    var localEditHQID = 0;
    if (parseInt(editHQID) && parseInt(editHQID) > 0)
    {
        editOrInsert = "editlemma";
        localEditHQID = editHQID;
    }
    else {
        editOrInsert = "newlemma";
    }

    $.ajax({
        url: "updategloss",
        type: "POST",
        data: {qtype:editOrInsert,hqid:localEditHQID, lemma:newLemma, strippedLemma:newLemmaStripped, pos:newPOS, def:newGloss, note:newNote},
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            //procResponse(data, textStatus); 
            showToast("success: " + data);
            console.log("realEditLemmaFormSubmit1: " + data);


            var returnObj;
            try {
                if (typeof JSON != "undefined") {
                    returnObj = JSON.parse(data);
                }
                else {
                    returnObj = eval("(" + data + ")");
                }
            }
            catch(e) { alert("Error: " + e.message + "\n" + data); return};
            
            if (!returnObj || returnObj.affectedrows < 1)
                return;

            var w = returnObj.words;

            for (var i = 0; w && i < w.length; i++)
            {
                //var wid = w[i].i;
                var lemmaid = w[i].hqid
                var lemma = w[i].l;
                var pos = w[i].pos;
                var gloss = w[i].g;
                //var seq = w[i].seq;

                updateAllListWordsWithLemmaID(lemma, pos, gloss, lemmaid);
            }
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error in realEditLemmaFormSubmit.");
            console.log("realEditLemmaFormSubmit2");
        }
    });
}

function realNewLemmaFormSubmit(newLemma, newPOS, newGloss, newNote)
{
    realEditLemmaFormSubmit(null, newLemma, newPOS, newGloss, newNote);
}

function realToggleArrow(vTextWordID, vLemmaID, toggleOff)
{
    var vTextWordIdOrZero = (toggleOff) ? 0 : vTextWordID;
    vToggleArrowPending = true;
    $.ajax({
        url: "updatedb",
        type: "POST",
        data: {qtype:"arrowWord",setArrowedIDTo: parseInt(vTextWordIdOrZero), forLemmaID: parseInt(vLemmaID) },
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            var returnObj = JSON.parse(data);
            if (returnObj.affectedRows == "1") {
                //clear arrow from all with this lemmaid first, so we never end up with multiple arrows displaying for same lemma
                $(".listword[lemmaid='" + vLemmaID + "'] > .listarrow").html(""); 

                //add or remove arrow to this word
                if (toggleOff) {        
                    $("#arrow" + vTextWordID).parent().removeClass("arrowedHere");
                }
                else {
                    $("#arrow" + vTextWordID).parent().addClass("arrowedHere");
                }
                //show or hide rows with same lemmaid after this row.
                //fix me, we are using id rather than seq.  should use seq
                $(".listword[lemmaid='" + vLemmaID + "']").each(function(idx,el){
                    if ( parseInt( el.id.substring(4) ) > parseInt( vTextWordID ) ) {
                        if (toggleOff) {
                            $(this).removeClass("alreadyArrowed");
                        }
                        else {
                            $(this).addClass("alreadyArrowed");
                        }
                    }   
                 });

                console.log(data);
            }
            else {
                showToast("error1 updating arrow for: arrow" + vTextWordID);
                console.log(data);
            }
            vToggleArrowPending = false;
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error2 updating arrow for: arrow" + vTextWordID);
            console.log("error updating arrow for: arrow" + vTextWordID);
            vToggleArrowPending = false;
        }
    });
}

var vToggleFlagPending = false;
function realToggleFlag(vTextWordID, flagged)
{
    var vIsFlagged = (flagged == 1) ? 1 : 0;
    vToggleFlagPending = true;
    $.ajax({
        url: "updatedb",
        type: "POST",
        data: {qtype:"flagUnflagWord",isFlagged:vIsFlagged, forWordID:vTextWordID},
        dataType: "text",//JSON automatically deserializes json
        success: function (data, textStatus, jqXHR){ 
            var returnObj = JSON.parse(data);
            if (returnObj.success) {
                //add or remove flag to this word
                if (returnObj.isFlagged == "1") {        
                    $("#word" + vTextWordID).addClass("flagged");
                }
                else {
                    $("#word" + vTextWordID).removeClass("flagged");
                }

                console.log(data);
            }
            else {
                showToast("error1 updating flag for: " + vTextWordID);
                console.log(data);
            }
            vToggleFlagPending = false;
        },
        error: function(response) {
            //getwords(url); //redo request on error
            showToast("error2 updating arrow for: arrow" + vTextWordID);
            console.log("error updating arrow for: arrow" + vTextWordID);
            vToggleFlagPending = false;
        }
    });
}

function setCookie(name, value, days) 
{
    if (days) 
    {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        var expires = "; expires=" + date.toGMTString();
    }
    else 
    {
        var expires = "";
    }
    document.cookie = name + "=" + value + expires + "; path=/;SameSite=Strict";
}

function getCookie(name)
{
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');

    for (var i = 0; i < ca.length; i++) 
    {
        var c = ca[i];

        while (c.charAt(0) == ' ') 
            c = c.substring(1, c.length);

        if (c.indexOf(nameEQ) == 0) 
            return c.substring(nameEQ.length, c.length);
    }
    return null;
}

function eraseCookie(name) 
{
    setCookie(name, "", -1);
}

function flagToggle() {
    if (vToggleFlagPending) {
        return;
    }
    var a = $("#word" + selectedWordInList);
    if ( a.length == 1) {

        var isFlagged = (a.hasClass("flagged")) ? 0 : 1; //invert
        realToggleFlag(selectedWordInList, isFlagged);
    }
}

async function uploadfile() {
    let formData = new FormData();    
    if ( $("#fileuploadtitle").val().length > 0 ) {
        formData.append("title", $("#fileuploadtitle").val());
        formData.append("file", fileupload.files[0]);
        
        let response = await fetch('importtext', {
            method: "POST", 
            body: formData
            //,headers: {'Content-Type': 'text/plain;charset=UTF-8' },  this breaks it, says no TEI.2 tag
        });

        if (response.status == 200) {
            let json_response = await response.json();
	        if (json_response.success) {
                showToast("Successfully imported text with " + json_response.words_inserted + " words.");
            }
            else {
                showToast("Error importing text (1): " + (typeof(json_response.error) != "undefined") ? json_response.error : "Unknown error" + ".");
            }
        }
        else {
            showToast("Error importing text (2).");
        }
        $("#uploadform").hide();
    }
}

function onResize() {
        const offset = 38;
        let w = lookupWT("test1");
        let w2 = lookupWT("text");
  
        w.setHeight( $(document).height() - offset );
        w2.setHeight( $(document).height() - offset );

        let width = ($(document).width() / 2);

        $(".WordContainer").css("width", "calc(100% - 30px");
        $(".wordtree").css("width", width - 19 + "px");
      }

      function toggleSettings() {
    var s = document.getElementById("settingsdiv");
    if (!s) {
      var s = document.createElement("div");
      s.id = "settingsdiv";
      s.classList.add("settings");
      s.style.display = "block";
      s.innerHTML = "Settings<br><ul><li><div tabindex='0' style='height:70px;'>dark mode: <div style='text-align:right;float:right;padding:0px;border:none;'>system <input id='darkModeSystem' type='radio' name='darkmode' onclick='darkModeClick(this);' value='system'/><br>dark <input id='darkModeDark' type='radio' name='darkmode' onclick='darkModeClick(this);' value='dark'/><br>light<input id='darkModeLight' type='radio' name='darkmode' onclick='darkModeClick(this);' value='light'/></div></div></li></ul>";
      var c = document.createElement("div");
      c.id="backdrop";
      c.onclick = function() {
        document.querySelector("#backdrop").style.display = "none";
        toggleSettings();
      };
      document.body.appendChild(c);
      document.body.appendChild(s);
    }
    else if (s.style.display == "block") {
      document.querySelector("#backdrop").style.display = "none";
      s.style.display = "none";
    }
    else {
      document.querySelector("#backdrop").style.display = "block";
      s.style.display = "block";
    }

    var a = localStorage.getItem("mode");
    switch (a) {
    case "dark":
      document.querySelector("#darkModeDark").checked = true;
      break;
    case "light":
      document.querySelector("#darkModeLight").checked = true;
      break;
    default:
      document.querySelector("#darkModeSystem").checked = true;
      break;
    }
  }

function darkModeClick(radio) {
  switch (radio.value) {
    case "dark":
      localStorage.setItem("mode", "dark");
      break;
    case "light":
      localStorage.setItem("mode", "light");
      break;
    default:
      localStorage.removeItem("mode");
      break;
  }
  setTheme();
}

window.onresize = onResize;

</script>
<style>
BUTTON {
    cursor:pointer;
}
#showButton,
#hideButton {
    position: absolute;
    top: 2px;
    right: 46px;
}
#showGlossUsesButton {
    position: absolute;
    top: -4px;
    right: 30px;  
}
#glosslistEditButton {
    position: absolute;
    top: -4px;
    right: 128px;  
}
#glosslistSelectButton {
    position: absolute;
    top: -4px;
    right: 175px;  
}
#selectTextButton {
    position: absolute;
    top: -4px;
    right: 106px;  
}
#uploadbutton {
    position: absolute;
    top: -4px;
    right: 35px;
}
#gotoGlossOccurrenceButton {
    position: absolute;
    top: -4px;
    right: 35px;
}
#glossusesclosebutton,
#glosslistclosebutton,
#testlistclosebutton {
    position: absolute;
    top: -4px;
    right: -5px;
    width:25px;
}
.openCloseBranch {
    display:inline-block;
    padding-right:8px;
    cursor:pointer;
    height: 14px;
    width: 14px;
    text-indent:0px; /*so we don't inherit parent's indentation*/
}
.nodeImg {
    fill:red;
    height: 14px;
    width: 14px;
    display:inline-block;
    top: 2px;
    position: relative;
}
.nodeClosed .nodePlus {
    display:inline-block;
}
.nodeClosed .nodeMinus {
    display:none;
}
.nodeOpen .nodePlus {
    display:none;
}
.nodeOpen .nodeMinus {
    display:inline-block;
}

.arrowedHere .listarrow::after {
    content:"→";
}
.flagged { border:2px solid red; }
.gkinput {font-family: WebIFAO, WebNewAthenaUnicode,NewAthenaUnicode, helvetica,arial;}
.alreadyArrowed { display:none;color:#999; } /*default*/
.alreadyArrowed .listarrow { display:none; }
#editbutton {float:right;}
.listpos {font-style: italic;}
.listpos[contenteditable="true"] {font-style: italic;background-color:white;}
.listheadword[contenteditable="true"] {font-weight: bold;background-color:white;}
.listdef[contenteditable="true"] {background-color:white;}
.listheadword {font-weight: bold;}
.listposwrapper {display:none;}
.listword:not(.hqListWord) .listheadword {
	color:red;
	font-weight: bold;
}

.wordlemma { color:red;}
.selectedWord { background-color:orange !important; }
.listword.selectedWord { }

.listword {cursor:pointer;
  position:relative;
  margin-left:30px;
  margin-top: 6px;
}
.clickablelistword {padding:4px;
  padding-left: 30px ;
  text-indent: -30px ;}
.listarrow {position:absolute;
top:4px;
left:-30px;
font-size: 11pt;
height: 20px;
width: 20px;
border: 1px solid #ddd;
text-indent:0px;
text-align:center;
}
.textword { cursor:pointer;}
.textword:hover { background-color:yellow;}

.superscript { 
    vertical-align: super;
    font-size: smaller;
}
html {
    height:100%;
    width:100%;
    overflow: hidden;
    position: fixed;
    margin:0px; 
    padding:0px;
    }
    BODY { 
    font-family: WebIFAO, NewAthenaUnicode, WebNewAthenaUnicode,helvetica,arial;
    font-size:12pt;
    overflow:hidden;
    margin:0px; 
    padding:0px;
    height:100%;
    width:100%;
    position: relative;
    background-color:#ccc;
    
    }
    #textdiv { 
    position:absolute;
    left:10px;
    top:33px;
    /*border:2px solid blue;*/
    border-radius:6px;
    width:calc(50% - 15px);
    height:calc(100% - 43px); 
    overflow-y: scroll;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch; 
    padding:0px;
    background-color:white;
    }
    #textcontents {
        margin:10px;
        line-height:1.4;
    }
    textarea {
    resize: none;
    }

    #words { 
    position:absolute;
    right:10px;
    top:33px;
    /*border:2px solid red;*/
    border-radius:6px;
    width:calc(50% - 15px);
    height:calc(100% - 43px); 
    overflow-y: scroll;
    overflow-x: hidden;
    -webkit-overflow-scrolling: touch;   
    padding:0px;
    background-color:white;
    }
    #wordscontents {
        margin:10px;
    }
    @font-face {
      font-family: 'WebNewAthenaUnicode';
      src: url('./newathu5_8.ttf') format('truetype');
    }
    @font-face {
      font-family: 'WebIFAO';
      src: url('./IFAOGrec.ttf') format('truetype');
    }

     /* The snackbar - position it at the bottom and in the middle of the screen */
#snackbar {
  visibility: hidden; /* Hidden by default. Visible on click */
  min-width: 250px; /* Set a default minimum width */
  margin-left: -125px; /* Divide value of min-width by 2 */
  background-color: #333; /* Black background color */
  color: #fff; /* White text color */
  text-align: center; /* Centered text */
  border-radius: 2px; /* Rounded borders */
  padding: 16px; /* Padding */
  position: fixed; /* Sit on top of the screen */
  z-index: 1; /* Add a z-index if needed */
  left: 50%; /* Center the snackbar */
  bottom: 30px; /* 30px from the bottom */
}

/* Show the snackbar when clicking on a button (class added with JavaScript) */
#snackbar.show {
  visibility: visible; /* Show the snackbar */
  /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
  However, delay the fade out process for 2.5 seconds */
  -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
  animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

/* Animations to fade the snackbar in and out */
@-webkit-keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
  from {bottom: 0; opacity: 0;}
  to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
  from {bottom: 30px; opacity: 1;}
  to {bottom: 0; opacity: 0;}
} 

.editformlabel {width:70px;font-family:helvetica;font-size:10pt;}
#editformcontainer, #annotateformcontainer {
position: absolute;
background-color: lightgray;
position: absolute;
top: 50%;
left: 50%;
margin-top: -150px;
margin-left: -300px;
width: 600px;
/*height: 220px;*/
padding: 14px;
display:none;
border: 2px solid black;
border-radius: 10px;
z-index:999;
}
#uploadform {
position: absolute;
background-color: lightgray;
position: absolute;
top: 50%;
left: 50%;
margin-top: -150px;
margin-left: -300px;
width: 600px;
/*height: 220px;*/
padding: 14px;
display:none;
border: 2px solid black;
border-radius: 10px;
z-index:999;
}
button {margin:1px 4px;border: 2px solid black;
border-radius: 6px;
height: 25px;}
.inputText { font-size:16pt;font-family:WebIFAO,WebNewAthenaUnicode,helvetica; }
#noclick {z-index:888;position:absolute;top:0px;left:0px;height:100%;width:100%;background-color:#222;opacity:0.5;display:none;}

.openCloseBranch {
    display:inline-block;
    padding-right:4px;
    padding-left:4px;
    cursor:pointer;
}
.nodestyle {
        /*line-height: 32px;*/
        margin:0px;
        position:relative;
        width:calc(100% - 30px); /* wt.width - 24 + "px";//"100%";*/
        background-color:white;
        overflow: hidden;
    }
#test1 .nodestyle {
    padding-left:30px;
    text-indent:-30px;
}
#text .nodestylecol {
    display:inline-block;
}
    .nodestylecol {
        paddingTop: 5px; /*fix me*/
        top: 0px;
        padding-top:6px;
        padding-bottom:6px;
    }
    .nodestylecol1 {
        padding-left:4px;
    }
    .nodestylecol2 {
        display:none !important;
    }
    .selectedRowClass {
        background-color: #8899EE;
        color: white;
    }
    .WordContainer {
      position: relative;
      left: 11px;
      overflow: auto;
      padding-top: 2px;
      font-size: 12pt;
      font-weight: normal;
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    
  /* Hide scrollbar for Chrome, Safari and Opera */
  .WordContainer::-webkit-scrollbar {
    display: none;
  }

  .wordtreetitlediv {
      position:absolute;
      top:17px;
      left:6px;
      width:calc(100% - 30px);
  }

  .wordtree {
    margin: 2px 10px;
    background-color: white;
    text-align: left;
    position: relative;
    border-radius: 10px;
    border: 2px solid black;
    z-index:990;
  }

  .wordtree input {
position: absolute;
top: 40px;
left: 8px;
border-radius: 13px;
border: 2px solid black;
padding-left: 6px;
height: 22px;
  }

  .lds-spinner {
  color: official;
  display: inline-block;
  position: relative;
  width: 20px;
  height: 20px;
}
.lds-spinner div {
  transform-origin: 40px 40px;
  animation: lds-spinner 1.2s linear infinite;
}
.lds-spinner div:after {
  content: " ";
  display: block;
  position: absolute;
  top: 28px;
  left: 39.5px;
  width: 2px;
  height: 6px;
  /*border-radius: 20%;*/
  background: red;
}

.lds-spinner div:nth-child(1) {
  transform: rotate(0deg);
  animation-delay: -1.1s;
}
.lds-spinner div:nth-child(2) {
  transform: rotate(30deg);
  animation-delay: -1s;
}
.lds-spinner div:nth-child(3) {
  transform: rotate(60deg);
  animation-delay: -0.9s;
}
.lds-spinner div:nth-child(4) {
  transform: rotate(90deg);
  animation-delay: -0.8s;
}
.lds-spinner div:nth-child(5) {
  transform: rotate(120deg);
  animation-delay: -0.7s;
}
.lds-spinner div:nth-child(6) {
  transform: rotate(150deg);
  animation-delay: -0.6s;
}
.lds-spinner div:nth-child(7) {
  transform: rotate(180deg);
  animation-delay: -0.5s;
}
.lds-spinner div:nth-child(8) {
  transform: rotate(210deg);
  animation-delay: -0.4s;
}
.lds-spinner div:nth-child(9) {
  transform: rotate(240deg);
  animation-delay: -0.3s;
}
.lds-spinner div:nth-child(10) {
  transform: rotate(270deg);
  animation-delay: -0.2s;
}
.lds-spinner div:nth-child(11) {
  transform: rotate(300deg);
  animation-delay: -0.1s;
}
.lds-spinner div:nth-child(12) {
  transform: rotate(330deg);
  animation-delay: 0s;
}
@keyframes lds-spinner {
  0% {
    opacity: 1;
  }
  100% {
    opacity: 0;
  }
}

#leftlist {
  /*background-color:white;*/
}

#hamburger {
  background-color: white;
  border:1px solid #666;
  border-radius:4px;
  cursor: pointer;
  height:26px;
  width:26px;
  position: absolute;
  right:10px;
}
#hamburger rect {
  fill: black;
}

#backdrop {
  position: absolute;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  z-index:900;
}

#settingsdiv ul {
  list-style-type: none;
  margin: 0px;
  padding: 0px;
  text-align: left;
}

.settings {
      position: absolute;
      top: 40px;
      right: 11px;
      height: 104px;
      width: 230px;
      z-index: 999;
      padding:10px;
    }

#settingsdiv {
  background-color: white;
  color:black;
  border: 2px solid black;
  border-radius:10px;
}

.dark #settingsdiv {
  background-color: black;
  color:white;
  border: 2px solid white;
}

.dark #settingsdiv li {
  color:white;
}


BUTTON { color:black;text-align:center;}

.dark BODY {background-color:black;color:white;}
.dark BUTTON{background-color:black;color:white;border:2px solid white;}
.dark #textcontents {background-color:#202124;color:white;}
.dark #wordscontents {background-color:#202124;color:white;}
.dark #textdiv {background-color:#202124;color:white;}
.dark #words {background-color:#202124;color:white;}
.dark .nodestyle {background-color:#202124;color:white;}
.dark .wordtree {background-color:#202124;color:white;}
.dark .wordtreeEntry {background-color:#202124;color:white;}
.dark .selectedRowClass { background-color: #8899EE; color: white; }
.dark #editformcontainer, .dark #uploadform {background-color:black;color:white;border:2px solid white;}
.dark .inputText {background-color:black;color:white;border:2px solid white;}
.dark .selectedWord { background-color:orange !important; }
.dark .listfrequency {color:#03a5fc;}

.dark #hamburger {
  background-color: black;
}
.dark #hamburger rect {
  fill: white;
}


</style>
</head>
<body onload="onload()">
<div style="padding-left:10px;padding-top:2px;font-family:helvetica,arial;">

    <button id="getTexts" onclick="selectTextFormToggle()">Select Text</button>

    <div style="position:absolute;top:0px;left:50%;width:50%;padding-top:2px;">
    <button id="selectLemmaButton" onclick="selectLemmaFormToggle()" >Select Gloss</button>
    <button id="newLemmaButton" onclick="newLemmaFormToggle()">New Gloss</button> 
    <button id="editLemmaButton" onclick="editLemmaFormToggle()">Edit Gloss</button> 
    <button id="hideButton" onclick="hide1()" style="display:none;">Hide Seen</button> 
    <button id="showButton"  onclick="show1()">Show All</button>
    <svg onclick="toggleSettings()" id="hamburger" viewBox="0 0 120 120">
        <rect x="10" y="30" width="100" height="12"></rect>
        <rect x="10" y="56" width="100" height="12"></rect>
        <rect x="10" y="82" width="100" height="12"></rect>
      </svg>
</div>
    <!--<button id="flagButton" onclick="flagToggle()" style="">Flag/Unflag</button>-->
    <!--<button id="annotateButton" onclick="annotateGloss()" style="">Annotate</button>-->
</div>
<div id="textdiv">
    <div id="textcontents"></div>
</div>
<div id="words">
    <div id="wordscontents"></div>
</div>
  <div id="leftlist" style="display:none;position:absolute;top:30px;left:0px;height:calc(100% - 30px);width:220px;"></div>
  <div id="textlist" style="display:none;position:absolute;top:30px;left:0px;height:calc(100% - 30px);width:220px;"></div>
  <div id="glossuseslist" style="display:none;position:absolute;top:30px;left:0px;height:calc(100% - 30px);width:220px;"></div>
  <div id="snackbar"></div>
  <div id="uploadcontainer">
      <div id="uploadform" style="display:none;">
        <h2>Upload TEI XML File</h2>
        Title: <input id="fileuploadtitle" class="inputText" type="text" name="fileuploadtitle" /><br/><br/>
        <input id="fileupload" type="file" name="fileupload" /><br/><br/>
        <button onclick="uploaddialog()">Cancel</button><button onclick="uploadfile()">Upload</button>
      </div>
  </div>
<div id="editformcontainer">
    <div id="editform" style="display:none;">
        <table style="width:100%;">
            <tr><td colspan="2" class="editformlabel" id="editFormTitle"></td>
            </tr>
        <tr>
            <td class="editformlabel">Lemma</td><td><input class="inputText gkinput" id="EditInputLemma" style="width:90%" type="text"/><span style="display:none;" id="EditInputHQID"></span></td>
        </tr>
        <!--<tr>
            <td class="editformlabel">Parent</td><td><button id="EditInputParentWord">Set Parent</button></td>
        </tr>-->
        <tr id="arrowedrow">
            <td class="editformlabel">Arrowed</td><td><input id="EditInputArrowed" type="checkbox"/></td>
        </tr>
        <tr>
            <td class="editformlabel">PoS</td><td><input class="inputText" id="EditInputPOS" style="width:90%" type="text"/></td>
        </tr>
        <tr>
            <td class="editformlabel">Gloss</td><td><textarea class="inputText" id="EditInputGloss" style="width:90%;height:96px;"></textarea></td>
        </tr>
        <tr>
            <td class="editformlabel">Internal Note</td><td><textarea class="inputText" id="EditInputNote" style="width:90%;height:96px;"></textarea></td>
        </tr>
        <tr>
            <td colspan="2" align="center"><button onclick="newLemmaFormClose()">Cancel</button><button onclick="newLemmaFormSubmit()">Submit</button></td>
        </tr>
        </table>
    </div>
</div>
<div id="annotateformcontainer">
    <div id="annotateform" style="display:none;">
    <table style="width:100%;">
        <tr>
            <td class="editformlabel">Note</td><td>
        <span style="display:none;" id="AnnotateWordID"></span>
        <textarea class="inputText" id="AnnotateInput" style="width:90%;height:96px;"></textarea>
</td>
        </tr>
        <tr>
            <td colspan="2" align="center"><button onclick="annotateFormClose()">Cancel</button><button onclick="annotateFormSubmit()">Submit</button></td>
        </tr>
        </table>
    </div>
</div>
<div id="noclick"></div>
</body>
</html>
